#!/usr/bin/env bash
set -eo pipefail

. $(dirname "$(readlink -f "$0")")/base
KUBERNETES_CONTEXT=$(kubernetes-context)
KUBERNETES_NAMESPACE=$(kubernetes-namespace)

ACTION=$1

MIGRATE_ARGS=()

if [ "$ACTION" == "create" ]; then
  MIGRATE_ARGS+=(
    'create'
    '-dir "/poeticmetric/pkg/service/migration/files/clickhouse"'
    '-ext sql'
    '-seq'
    "${@:2}"
  )
else
  MIGRATE_ARGS+=(
    '-database "clickhouse://${CLICKHOUSE_HOST}:${CLICKHOUSE_PORT}?username=${CLICKHOUSE_USER}&password=${CLICKHOUSE_PASSWORD}&database=${CLICKHOUSE_DATABASE}&x-multi-statement=true"'
    '-source "file:///poeticmetric/pkg/service/migration/files/clickhouse"'
    "$@"
  )
fi

echo ${MIGRATE_ARGS[@]}

MIGRATE_CMD="migrate ${MIGRATE_ARGS[@]}"

kubectl \
  --context "${KUBERNETES_CONTEXT}" \
  --namespace ${KUBERNETES_NAMESPACE} \
  exec deployment/poeticmetric-rest-api -- \
    bash -c "${MIGRATE_CMD}"
